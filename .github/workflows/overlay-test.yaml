name: Kustomize Overlay Test

on:
  workflow_dispatch:
    inputs:
      application:
        description: "Select application type (e.g., go-api, java-api, python-api)"
        required: true
        default: "go-api"
      replicas:
        description: "Number of replicas"
        required: false
        default: "1"
      cpu_limit:
        description: "CPU limit (e.g., 500m, 1)"
        required: false
        default: "500m"
      memory_limit:
        description: "Memory limit (e.g., 256Mi, 512Mi)"
        required: false
        default: "256Mi"

jobs:
  test-kustomize:
    name: Test Kustomize Overlays from External Repo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout This Repository
        uses: actions/checkout@v3

      - name: Clone Kustomize Base Repository (External)
        run: |
          git clone https://github.com/bgcodehub/kustomize-application.git kustomize-base
          ls -R kustomize-base

      - name: Set Up Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Generate Patch Configuration
        run: |
          PATCH_PATH="kustomize-base/${{ github.event.inputs.application }}/patches"
          mkdir -p $PATCH_PATH

          cat <<EOF > $PATCH_PATH/patch.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: my-app
          spec:
            replicas: ${{ github.event.inputs.replicas }}
            template:
              spec:
                containers:
                - name: my-app
                  resources:
                    limits:
                      cpu: "${{ github.event.inputs.cpu_limit }}"
                      memory: "${{ github.event.inputs.memory_limit }}"
          EOF

      - name: Debug - Check Generated Patch Files
        run: |
          echo "Checking patch directory contents..."
          ls -R kustomize-base/${{ github.event.inputs.application }}/patches

      - name: Run Kustomize Build
        run: |
          kustomize build kustomize-base/${{ github.event.inputs.application }}/patches

      - name: Validate Kustomize Output
        run: |
          kustomize build kustomize-base/${{ github.event.inputs.application }}/patches | kubeval
